import { ObjectId } from "mongodb";
import DocCollection, { BaseDoc } from "../framework/doc";
import { NotFoundError } from "./errors";

export interface ProfileDoc extends BaseDoc {
  username: string;
  bio: string;
  image: string;
}

export default class ProfileConcept {
  public readonly profiles: DocCollection<ProfileDoc>;

  constructor(name: string) {
    this.profiles = new DocCollection<ProfileDoc>(name);
  }

  async create(_id: ObjectId, username: string, bio: string, image: string) {
    // TODO: use the _id generated by the account entry
    await this.profiles.createOne({ _id, username, bio, image });
    return { msg: "Profile created successfully!", profile: await this.profiles.readOne({ _id }) };
  }

  async getProfileById(_id: ObjectId) {
    const profile = await this.profiles.readOne({ _id });
    if (profile === null) {
      throw new NotFoundError(`User not found!`);
    }
    return profile;
  }

  async getProfileByUsername(username: string) {
    const profile = await this.profiles.readOne({ username });
    if (profile === null) {
      throw new NotFoundError(`User not found!`);
    }
    return profile;
  }

  // TODO: type this
  async update(_id: ObjectId, updates: Partial<ProfileDoc>) {
    // TODO: make this more scalable
    await this.profiles.partialUpdateOne({ _id }, { ...updates });
    return { msg: "Username updated successfully!" };
  }
}
